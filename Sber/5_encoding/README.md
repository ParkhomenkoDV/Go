# Основы REST API

Сложно представить себе программу, в которой ничего не надо было бы конвертировать. Часто требуется читать настройки из YAML-файла и использовать JSON-формат в HTTP-запросах и ответах. Поэтому для разработчика важно уметь работать с разными форматами представления данных, знать возможности и ограничения сериализации и десериализации.

В начале темы `encoding`, состоящей из четырёх уроков, разберём основные принципы архитектурного стиля REST, который чаще всего используется для обмена сообщениями в формате JSON. Затем рассмотрим структурные теги — они позволяют указывать метаинформацию об объекте или типе объекта, что даёт возможность соотносить поля структур и конечные данные при сериализации и обратном преобразовании. Два последних урока посвящены стандартным и сторонним сериализаторам данных.

В этой теме вы узнаете:
- как применять пакеты сериализации из стандартной библиотеки Go (для форматов JSON, XML и gob);
- как добавлять поддержку сериализации пользовательских типов данных и работать с динамическими спецификациями;
- в каких случаях альтернативные решения лучше стандартных (на примере внешнего пакета `easyjson`);
- какие внешние библиотеки можно использовать для работы с форматами YAML, TOML, MessagePack и Protocol Buffers.

Упомянутые в уроках форматы применяются в разработке одинаково часто, но вам стоит уделить особое внимание работе с JSON — с ним будут связаны задания по учебному проекту.

В этом уроке расскажем, что представляют собой API и архитектурный стиль REST, из каких элементов состоит REST API и каким критериям должна удовлетворять архитектура REST. Также поговорим о преимуществах стиля REST перед другими стандартами взаимодействия систем и рассмотрим, как работает REST API. 

## Что такое REST API

**API (Application Programming Interface, программный интерфейс приложения)** — это набор правил и функций, позволяющих приложениям взаимодействовать друг с другом.

API выступает посредником между приложениями, перенаправляя запросы (requests) и ответы (responses) от клиента к серверу и обратно. Например, аутентификация пользователя в приложении через существующий аккаунт в Яндексе происходит через API Yandex, который разработчики интегрировали в своё приложение.

**REST (Representational State Transfer, передача состояния представления)** — это программная архитектура, которая определяет условия работы API.

API, соответствующие архитектурному стилю REST, называют REST API. 

REST API — это интерфейс, который используют две компьютерные системы для безопасного обмена информацией через HTTP.

Веб-службы, реализующие архитектуру REST, называют RESTful. Как правило, термин RESTful API относится к сетевым API. Но в целом REST API и RESTful API — это взаимозаменяемые понятия.

Архитектура REST не привязана к конкретным технологиям и протоколам, но построение RESTful API почти всегда подразумевает использование методов HTTP и распространённых форматов представления данных — например, JSON или XML.

Схематически REST API можно представить так:
![](./assets/images/rest_api.png)

## Элементы REST API

Сетевой API функционирует как шлюз между основными элементами архитектуры REST — клиентами, ресурсами и серверами.

**Клиент (client)** — это программа, которая позволяет пользователю получить доступ к информации в интернете и задействует для этого API. Например, разработчики создают приложение, которое получает доступ к данным новостей. Этот доступ можно получить и в браузере, посетив новостной сайт.

**Ресурс (resource)** — это информация, которую приложение предоставляет своим клиентам. Ресурсами могут быть изображения, видео, тексты, числа и любые другие данные. 

**Сервер (server)** — это компьютер, который отправляет ресурсы клиенту. 

API позволяет клиентам совместно использовать ресурсы и предоставляет веб-службы, которые обеспечивают безопасность, контроль и аутентификацию. Кроме того, API помогает определить, какие клиенты могут получить доступ к внутренним ресурсам, а какие нет.

## Принципы REST

Теперь приведём основные принципы архитектурного стиля REST. Чтобы распределённая система соответствовала этому стилю, она должна удовлетворять следующим критериям:
1. **Клиент-серверная архитектура (client–server architecture).** Система должна быть разделена на клиент и сервер таким образом, чтобы клиент не был связан с хранением данных на сервере, а сервер — с интерфейсом и состоянием клиента. Это позволяет разрабатывать клиент и сервер независимо друга от друга, а также делать сервер простым и масштабируемым.
1. **Отсутствие состояния (statelessness).** Сервер не должен хранить данные о состоянии сессии между запросами и ответами. Информация, необходимая для обработки запроса и идентификации клиента, должна передаваться в самом запросе. Это помогает снизить нагрузку на сервер.
1. **Возможность кешировать ответ (cacheability).** Кеширование позволяет повысить производительность за счёт использования сохранённых ранее данных. При этом клиент должен точно знать, какая информация закеширована, а какая нет, чтобы при повторном запросе к серверу не использовать устаревшие или некорректные данные.
1. **Многослойная система (layered system).** Между клиентом и сервером можно добавлять промежуточный сервер — это позволяет обеспечивать безопасность и балансировку нагрузки, использовать общий кеш и улучшать масштабируемость. Система может быть разделена на иерархию слоёв, при этом каждый компонент системы должен видеть только компоненты следующего слоя. Например, если вы вызываете службу PayPal, а она — службу Visa, то вы не увидите вызова Visa.
1. **Код по требованию (code-on-demand).** Допускается загрузка и выполнение кода или программы на стороне клиента, но это необязательно.
1. **Единый интерфейс (uniform interface).** Это упрощает архитектуру и позволяет каждой её части развиваться самостоятельно. Вот четыре принципа единого интерфейса:
    - **Идентификация ресурса.** В REST ресурсом является всё, чему можно дать имя: пользователь, изображение, предмет и так далее. У каждого ресурса есть идентификатор, который не меняется при изменении состояния ресурса. Идентификатор в REST — это URI (Uniform Resource Identifier).
    - **Манипуляции над ресурсами через представления.** Представление — это текущее или желаемое состояние ресурса. Например, если ресурсом является пользователь, то представлением может быть XML- или HTML-описание этого пользователя.
    - **Самодостаточные сообщения.** Запрос и ответ содержат всю необходимую информацию для их обработки. Дополнительные сообщения или запись состояния не нужны.
    - **Гипермедиа как средство управления состоянием.** Состояние ресурса передаётся через тело ответа, параметры, заголовки и URI — это и есть гипермедиа. В само XML- или JSON-представление ресурса добавляются гиперссылки, по которым клиент может переходить к другим доступным на данный момент ресурсам.

## Преимущества REST API

API можно проектировать в соответствии с разными протоколами и стандартами. Вот несколько из них:
- RPC (Remote Procedure Call, удалённый вызов процедур) — класс технологий, позволяющих программам вызывать функции или процедуры в другом адресном пространстве, на удалённых узлах либо в независимой сторонней системе на том же узле.
- XML-RPC — вид RPC, который позволяет организовать обмен функциями между двумя или более сетями, передаёт информацию от клиента серверу по протоколу HTTP, а для описания запросов и ответов использует формат XML.
- JSON-RPC — облегчённый RPC, использующий для запросов и ответов формат JSON и предоставляющий возможность асинхронных ответов.
- SOAP (Simple Object Access Protocol, простой протокол доступа к объектам) — фреймворк для обмена структурированной информацией при реализации веб-сервисов в компьютерных сетях. SOAP использует формат XML, позволяет клиентам вызывать веб-сервисы и получать ответы независимо от языка и платформы.

Протоколы и стандарты задают жёсткие рамки по форматам сообщений, используемым технологиям и способам взаимодействия. Тогда как архитектурный стиль REST лишь предлагает придерживаться нескольких принципов и ограничений. 

Перечислим преимущества REST перед описанными стандартами:
1. **Масштабируемость.** Отсутствие хранения состояния снижает нагрузку на сервер: ему не нужно фиксировать информацию о предыдущих запросах клиента. Кеширование уменьшает количество взаимодействий между сервером и клиентом. В конечном счёте это позволяет увеличить пропускную способность сервиса, не уменьшив при этом производительность.
1. **Гибкость.** Большинство программных интерфейсов работают в формате «приложение — приложение», а веб-службы REST API поддерживают полное разделение сервера и клиента. Это позволяет каждому компоненту системы развиваться независимо. Изменения платформы или технологии в серверном приложении не влияют на клиентское приложение. Возможность разделять функции на уровни ещё больше повышает гибкость. Например, разработчики могут вносить изменения в уровень базы данных, не переписывая логику приложения.
1. **Независимость.** REST API не зависит от используемой технологии. Можно создавать как клиентские, так и серверные приложения на разных языках программирования, не затрагивая структуру API.
1. **Разноформатность.** Обычно API используют конкретные форматы сообщений — например, SOAP использует XML. В REST обмен сообщениями может быть организован в JSON, XML и любом другом формате.

Далее разберём подробнее, как работает REST API: что содержит запрос, ответ и что такое идемпотентность. Перед продолжением рекомендуем вам провести небольшой перерыв —  размяться, отвести взгляд от экрана и дать голове отдохнуть, чтобы вернуться к изучению материала с новыми силами.

## Как работает REST API

Клиент связывается с сервером через API, когда ему требуется доступ к какому-либо ресурсу. Вот основные этапы работы REST API:
1. Клиент отправляет запрос к серверу.
1. Сервер аутентифицирует клиента и подтверждает, что он имеет право запрашивать информацию.
1. Сервер получает запрос и обрабатывает его.
1. Сервер возвращает ответ клиенту. Ответ содержит сведения о том, был ли запрос успешным: если да, в ответ включаются запрошенные данные.

## Что содержит клиентский запрос

В RESTful API запросы должны содержать следующие компоненты: уникальный идентификатор ресурса, метод, заголовки, данные, параметры.

### Уникальный идентификатор ресурса

Сервер присваивает каждому ресурсу уникальный идентификатор. В случае со службами REST сервер идентифицирует ресурсы с помощью URL, который указывает путь к ресурсу. Путь аналогичен адресу веб-страницы, который вы вводите в браузере для её посещения. URL также называют адресом запроса — он чётко указывает серверу, что требуется клиенту.

### Метод

Как правило, разработчики реализуют RESTful API с помощью HTTP. Метод HTTP сообщает серверу, что ему необходимо сделать с ресурсом. Ниже приведены четыре распространённых метода HTTP:
- `GET` — используется для доступа к ресурсам, расположенным на сервере по указанному URL. Клиенты могут кешировать запросы `GET` и отправлять в запросе параметры, чтобы сообщить серверу о необходимости фильтровать данные перед отправкой.
- `POST` — используется для отправки данных на сервер. При этом клиенты включают в запрос представление данных. Отправка одного и того же запроса `POST` несколько раз имеет побочный эффект — многократное создание одного и того же ресурса.
- `PUT` — используется для обновления существующих на сервере ресурсов. В отличие от POST, отправка одного и того же запроса PUT несколько раз даёт одинаковый результат в веб-службе.
- `DELETE` — используется для удаления ресурса.

Здесь стоит упомянуть про CRUD-операции RESTful API. CRUD — это аббревиатура от команд `Create`, `Read`, `Update` и `Delete`. Эти четыре основные операции помогают разработчикам взаимодействовать с базами данных. Несмотря на то что термин CRUD пришёл из баз данных, сегодня он отражает принцип разработки динамических приложений — например, HTTP, SQL и DDS (Data Distribution Service, cлужба распространения данных). 

Вот какие задачи выполняют команды CRUD:
- `Create` — создаёт новую запись.
- `Read` — читает данные на основе требуемых входных параметров.
- `Update` — изменяет запись (без перезаписи).
- `Delete` — удаляет одну или несколько записей.

### Заголовки

Заголовки запросов — это метаданные, которыми обмениваются клиент и сервер. Например, заголовок может указывать формат запроса и ответа или предоставлять информацию о статусе запроса.

### Данные

Запросы REST API могут включать данные для успешной работы `POST`, `PUT` и других методов HTTP.

### Параметры

Запросы RESTful API могут включать параметры, которые предоставляют серверу более подробную информацию о необходимых действиях:
- Параметры пути — определяют детали URL.
- Параметры запроса — запрашивают дополнительную информацию о ресурсе.
- Параметры cookie — быстро аутентифицируют клиентов.

## Что содержит ответ сервера

Принципы REST требуют, чтобы ответ сервера содержал следующие компоненты: строку состояния, текст сообщения и заголовки.

### Строка состояния

Строка состояния содержит трёхзначный код, который сообщает об успешном или неудачном выполнении запроса. Например, коды `2XX` указывают на успешное выполнение, а коды `4XX` и `5XX` — на ошибки. Коды `3XX` указывают на перенаправление URL.

### Текст сообщения

Текст ответа содержит представление ресурса. Сервер выбирает подходящий формат представления на основе заголовков запроса. Клиенты могут запрашивать информацию в XML или JSON — они определяют запись данных в виде обычного текста. 

Например, если клиент запрашивает имя и возраст человека по имени Саша, сервер возвращает текст сообщения в формате JSON:
```json
{"name":"Sasha", "age":30}
```

### Заголовки

Заголовки или метаданные об ответе дают более подробный контекст и включают в себя название сервера, кодировку, дату и тип контента.

## Идемпотентность

В RESTful-сервисе операция (или вызов сервиса) считается идемпотентной, если многократная отправка идентичных запросов имеет такой же эффект, как отправка одного.

Несмотря на то что идемпотентные операции производят один и тот же результат на сервере, ответ может быть разным: например, состояние ресурса может меняться между запросами.

Методы `PUT` и `DELETE` по определению идемпотентны. Тем не менее есть нюанс с методом `DELETE`. Успешный `DELETE`-запрос возвращает статус `200 OK` или `204 No Content`, но для последующих запросов будет всё время возвращать `404 Not Found`. Состояние на сервере после вызова `DELETE` остаётся тем же, но ответы разные.

Методы `GET`, `HEAD`, `OPTIONS` и `TRACE` определены как безопасные. Это значит, что они нужны только для получения информации и не меняют состояние сервера. Они не должны иметь побочных эффектов, за исключением безобидных, таких как логирование, кеширование, показ баннерной рекламы или увеличение веб-счётчика.

Безопасные операции идемпотентны, так как они приводят к одному и тому же результату на сервере. Безопасные методы реализованы как операции только для чтения. Однако безопасность не означает, что сервер должен возвращать всегда одинаковый результат.

## Почему именно REST API

REST — самый распространённый способ создания API для серверных приложений. 

Кроме прочих, к его плюсам можно отнести и то, что он простой в реализации и понимании. Большинство пользователей интернета интуитивно понимают, как он устроен. Когда пользователь вводит URL в строку браузера и нажимает Enter, он отправляет запрос на REST API сервера. REST API представляет собой множество эндпоинтов, отправляя запрос на которые клиент получает ответ от сервера.

В то же время REST API не всегда подходит для сложных или ресурсоёмких задач. На практике сервисы лишь частично соответствуют REST-принципам, а следование REST как догме может привести к неоптимальным решениям. Выбор подхода зависит от конкретных требований и условий.

## Дополнительные материалы

- [Хабр | Архитектура REST](https://habrahabr.ru/post/38730/) — статья о стиле REST.
- [Хабр | Hypermedia — то, без чего ваше API не совсем REST](https://habr.com/ru/companies/aligntechnology/articles/281206/) — подробнее о гиперссылках в сообщениях.
- [REST API Tutorial](https://restapitutorial.com/resources.html) — лучшие практики в разработке RESTful-сервисов.

# Структурные теги